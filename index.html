<script>
  // ====== CONFIG ======
  const MANAGER_CODE = "azoul-admin-2025"; // change for production

  // ====== COLOR MAP ======
  const issueColors = {
    "harassment": "b-red",
    "safety": "b-red",
    "burnout": "b-orange",
    "overtime": "b-amber",
    "low-pay": "b-indigo",
    "management": "b-purple",
    "career": "b-teal",
    "benefits": "b-blue",
    "culture": "b-slate",
  };

  // ====== DOM ======
  const loginPanel = document.getElementById('loginPanel');
  const dashPanel  = document.getElementById('dashPanel');
  const mEmail     = document.getElementById('mEmail');
  const mCode      = document.getElementById('mCode');
  const mWho       = document.getElementById('mWho');
  const loginBtn   = document.getElementById('loginBtn');

  const teamFilter = document.getElementById('teamFilter');
  const issueFilter= document.getElementById('issueFilter');
  const resetBtn   = document.getElementById('resetBtn');
  const reportList = document.getElementById('reportList');
  const countText  = document.getElementById('countText');

  // ====== Helpers ======
  const getReports = () => JSON.parse(localStorage.getItem('azoul_reports') || '[]');
  const setReports = (arr) => localStorage.setItem('azoul_reports', JSON.stringify(arr));

  // Ensure each report has a stable id (migrates legacy data once)
  const ensureIds = (arr) => {
    let changed = false;
    const out = arr.map(r => {
      if (!r.id) {
        changed = true;
        return { ...r, id: `r_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}` };
      }
      return r;
    });
    if (changed) setReports(out);
    return out;
  };

  const renderBadge = (key) => {
    const cls = issueColors[key] || 'b-slate';
    const pretty = ({
      "low-pay":"Low Pay",
      "harassment":"Harassment",
      "burnout":"Burnout",
      "overtime":"Overtime",
      "safety":"Safety",
      "management":"Management",
      "career":"Career Growth",
      "benefits":"Benefits",
      "culture":"Culture"
    })[key] || key;
    return `<span class="badge ${cls}">${pretty}</span>`;
  };

  const uniqueTeams = (arr) => [...new Set(arr.map(r => (r?.user?.team || 'N/A')))].sort((a,b)=>a.localeCompare(b));

  const applyFilters = (data) => {
    const t = teamFilter.value;
    const i = issueFilter.value;
    return data.filter(r => {
      const teamOK = (t === 'all' || (r?.user?.team || 'N/A') === t);
      const issueOK = (i === 'all' || (r?.selections || []).includes(i));
      return teamOK && issueOK;
    });
  };

  // ====== NEW: card actions (resolve + delete) ======
  const renderList = (data) => {
    const items = data.map(r => {
      const email = r?.user?.email || 'Unknown';
      const team = r?.user?.team || 'N/A';
      const when = r?.savedAt ? new Date(r.savedAt).toLocaleString() : '—';
      const badges = (r?.selections || []).map(renderBadge).join(' ');
      const other = r?.other || '—';
      const resolved = !!r?.resolved;

      return `
        <div class="card" data-id="${r.id}">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div><strong>${email}</strong> · <span class="muted">${team}</span></div>
            <div class="muted">${when}</div>
          </div>

          <div class="badges">${badges || '<span class="badge b-slate">No issue selected</span>'}</div>
          <div><span class="muted">Other:</span> ${other}</div>

          <div class="card-actions" style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px">
            <div>
              <span class="muted" style="font-size:12px;">Status:</span>
              ${resolved
                ? '<span class="badge b-teal" title="This report is resolved">Resolved</span>'
                : '<span class="badge b-orange" title="This report is unresolved">Unresolved</span>'}
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn btn-small resolve-btn" data-id="${r.id}" style="padding:8px 12px;border-radius:8px;">
                ${resolved ? 'Mark Unresolved' : 'Mark Resolved'}
              </button>
              <button
                class="icon-btn delete-btn"
                data-id="${r.id}"
                title="${resolved ? 'Delete this report' : 'Resolve before deleting'}"
                aria-label="Delete"
                ${resolved ? '' : 'disabled'}
                style="
                  background:transparent;border:1px solid rgba(15,23,42,.2);color:#0f172a;
                  width:36px;height:36px;border-radius:8px;font-weight:900;cursor:${resolved?'pointer':'not-allowed'};
                "
              >
                ×
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
    reportList.innerHTML = items || `<div class="card">No reports yet.</div>`;
    countText.textContent = `${data.length} result${data.length===1?'':'s'}`;
  };

  // ====== Login flow ======
  loginBtn.addEventListener('click', () => {
    const email = mEmail.value.trim();
    const code  = mCode.value.trim();
    if(!email || !code){ alert('Fill all fields'); return; }
    if(code !== MANAGER_CODE){ alert('Wrong manager code'); return; }

    // show dashboard
    loginPanel.style.display = 'none';
    dashPanel.style.display  = 'block';
    mWho.textContent = email;

    // load + migrate ids
    let all = ensureIds(getReports());

    // populate team filter
    const teams = uniqueTeams(all);
    teamFilter.innerHTML = `<option value="all">All Teams</option>` + teams.map(t => `<option value="${t}">${t}</option>`).join('');

    // render initial
    const refresh = () => renderList(applyFilters(all));
    renderList(all);

    // filters wiring
    teamFilter.addEventListener('change', refresh);
    issueFilter.addEventListener('change', refresh);
    resetBtn.addEventListener('click', () => {
      teamFilter.value = 'all';
      issueFilter.value = 'all';
      refresh();
    });

    // ====== NEW: event delegation for Resolve & Delete ======
    reportList.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      if (!id) return;

      // Refresh helper to keep filters applied
      const rerender = () => {
        // re-read to stay in sync across tabs or other changes
        all = ensureIds(getReports());
        renderList(applyFilters(all));
      };

      if (btn.classList.contains('resolve-btn')) {
        const next = all.map(r => r.id === id ? { ...r, resolved: !r.resolved } : r);
        setReports(next);
        rerender();
      }

      if (btn.classList.contains('delete-btn')) {
        // Only allow if resolved (button is disabled otherwise)
        const target = all.find(r => r.id === id);
        if (!target) return;
        if (!target.resolved) return;

        const ok = confirm('Delete this report permanently? This cannot be undone.');
        if (!ok) return;

        const next = all.filter(r => r.id !== id);
        setReports(next);
        rerender();
      }
    });
  });

  // ====== Guard: if no file found (prevent "code at top" leftovers) ======
  window.addEventListener('DOMContentLoaded', ()=>{
    ['#debug','#dump','.raw','.codesat','pre.dump','pre.raw'].forEach(sel =>
      document.querySelectorAll(sel).forEach(n => n.remove())
    );
  });
</script>
