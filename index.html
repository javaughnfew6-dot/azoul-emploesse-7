<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Azoul ¬∑ Manager Dashboard</title>

<!-- Chart.js for the Well‚ÄëBeing donut -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#0d162b;
    --bg-soft:#0b162a;
    --panel:#101f39;
    --brand:#2363ff;
    --ring: rgba(35,99,255,.35);

    --tab-text:#122345;          /* dark blue text for "file" tabs */
    --tab-blue:#1f3b78;          /* blue corner/accents for tabs */
    --tab-border:#d8e3ff;        /* soft blue border on white tabs */

    /* Severity colors */
    --sev-red:#dc2626;
    --sev-yellow:#eab308;
    --sev-green:#22c55e;

    /* Reply panel */
    --modal-bg:#0f1d35;
    --modal-br:#233460;
  }

  *{ box-sizing: border-box }
  html,body{ height:100% }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Arial,sans-serif;
    background: linear-gradient(180deg,#0a1530, var(--bg) 28%, #0a1530 100%);
    color:#e6eefb;
  }
  .wrap{ max-width:1040px; margin:auto; padding:20px }
  header{ display:flex; align-items:center; gap:.6rem; margin-bottom:16px }
  header .dot{ width:10px;height:10px;border-radius:50%; background:conic-gradient(#4da3ff,#c6dcff,#7fb5ff,#4da3ff); box-shadow:0 0 16px rgba(77,163,255,.6) }
  header .brand{ font-weight:800 }

  .panel{
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:16px; backdrop-filter: blur(6px);
  }
  .panel-inner{
    background:var(--panel); border:1px solid rgba(255,255,255,.08);
    border-radius:12px; padding:18px;
  }
  h1{ font-size:24px; margin: 0 0 10px }
  label{ font-size:13px; color:#dbeafe; margin:4px 0 6px; display:block }
  .input, textarea, select{
    width:100%; background:var(--bg-soft); border:1.5px solid rgba(255,255,255,.12); color:#e6edf7;
    border-radius:10px; padding:12px; outline:none;
  }
  .input:focus, textarea:focus, select:focus{ border-color:var(--brand); box-shadow:0 0 0 4px var(--ring) }
  textarea{ min-height:120px; resize:vertical }
  .btn{
    appearance:none; border:none; cursor:pointer; background:var(--brand); color:white; font-weight:800;
    padding:12px 16px; border-radius:10px; box-shadow:0 10px 18px rgba(35,99,255,.28);
  }
  .btn:disabled{ opacity:.6; cursor:not-allowed }
  .btn-ghost{
    appearance:none; border:1px solid rgba(255,255,255,.25); background:transparent; color:#e6eefb;
    padding:10px 14px; border-radius:10px; font-weight:800;
  }
  .btn-mini{
    appearance:none; border:none; cursor:pointer; background:#1e3a8a; color:#fff; font-weight:800;
    padding:8px 10px; border-radius:8px; font-size:12px;
  }
  .btn-mini.ghost{
    background:transparent; color:#1e3a8a; border:1px solid #c7d2fe;
  }

  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px }
  @media (max-width:760px){ .row{ grid-template-columns:1fr } }

  .filters{ display:flex; flex-wrap:wrap; gap:10px; margin: 8px 0 16px }
  select{
    background:var(--bg-soft); color:#e6edf7; border:1.5px solid rgba(255,255,255,.12);
    border-radius:10px; padding:10px 12px; outline:none;
  }

  /* Cards for reports */
  .card{
    background:#ffffff; color:#0f172a; border:1px solid #e6eaf2; border-radius:14px; padding:14px;
    box-shadow:0 6px 16px rgba(8,15,30,.1);
    position: relative;
    padding-right:56px; /* room for trash button */
    overflow: visible;
  }
  .list{ display:grid; gap:12px }

  .badges{ display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 }
  .badge{
    display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
    font-weight:700; font-size:12px; border:1px solid;
  }
  /* Color tokens for issue badges */
  .b-red{ background:#fee2e2; color:#7f1d1d; border-color:#fecaca }
  .b-orange{ background:#ffedd5; color:#7c2d12; border-color:#fed7aa }
  .b-amber{ background:#fef3c7; color:#78350f; border-color:#fde68a }
  .b-indigo{ background:#e0e7ff; color:#1e1b4b; border-color:#c7d2fe }
  .b-purple{ background:#f3e8ff; color:#581c87; border-color:#e9d5ff }
  .b-teal{ background:#ccfbf1; color:#134e4a; border-color:#99f6e4 }
  .b-blue{ background:#dbeafe; color:#1e3a8a; border-color:#bfdbfe }
  .b-slate{ background:#e2e8f0; color:#0f172a; border-color:#cbd5e1 }

  .muted{ color:#334155 }
  .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px }
  .pill{ background:#eef2ff; border:1px solid #c7d2fe; color:#1f2a5c; border-radius:999px; padding:8px 12px; font-weight:800 }
  .right{ display:flex; gap:8px; align-items:center; }

  /* BIG, visible trash delete button */
  .del-x {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 1px solid #7a2a2a;
    background: #c43d3d;
    color: #fff;
    font-weight: 900;
    font-size: 18px;
    line-height: 30px;
    text-align: center;
    cursor: pointer;
    z-index: 5;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    user-select: none;
    transition: .15s ease;
  }
  .del-x:hover { filter: brightness(1.05); }
  .del-x:active { transform: translateY(1px); }

  /* ===== "FILE" style tabs (white labels with blue folded corner) ===== */
  .folderTabs{
    display:flex; flex-direction:column; gap:10px; /* vertical like your image */
    max-width: 300px;
  }
  @media (min-width:900px){
    .folderArea{ display:grid; grid-template-columns: 300px 1fr; gap:18px; align-items:start; }
  }

  .folderTab{
    position:relative;
    width:100%;
    text-align:left;
    background:#ffffff;
    color:var(--tab-text);
    border:1px solid var(--tab-border);
    border-radius:10px;
    padding:14px 46px 14px 16px; /* space for corner fold */
    font-weight:900;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(8,15,30,.14);
    transition:.18s ease;
  }
  .folderTab:hover{ transform: translateY(-1px); }
  .folderTab.active{ outline:3px solid rgba(31,59,120,.14); }

  /* blue folded corner */
  .folderTab::after{
    content:"";
    position:absolute;
    top:0; right:0;
    width:0; height:0;
    border-left:18px solid transparent;
    border-top:18px solid var(--tab-blue);
    border-top-right-radius:9px;
  }

  .tabRow{
    display:flex; align-items:center; gap:8px;
  }
  .tabLabel{ font-size:14px; letter-spacing:.2px }
  .tabHint{ font-size:12px; opacity:.7; font-weight:700 }
  .tabCount{
    margin-left:auto;
    background:#e6efff; color:#1d2b52;
    border:1px solid #cfe0ff;
    padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900;
  }

  /* Pane / lists */
  .folderBody{ background:#0f1d35; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:14px; }
  .tabPane{ display:none }
  .tabPane.active{ display:block }

  /* Severity accent on cards */
  .sev-green{ border-left:6px solid var(--sev-green); }
  .sev-yellow{ border-left:6px solid var(--sev-yellow); }
  .sev-red{ border-left:6px solid var(--sev-red); }

  /* Card footer actions */
  .cardActions{
    display:flex; gap:8px; align-items:center; margin-top:8px;
  }
  .notePill{
    display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px;
    background:#e6efff; color:#1e2b55; border:1px solid #cfe0ff; font-size:12px; font-weight:900;
  }

  /* Empty state */
  .empty{
    padding:18px; text-align:center; color:#cbd5e1; border:1px dashed rgba(255,255,255,.18);
    border-radius:12px; background:rgba(255,255,255,.04);
  }

  /* ===== Reply Drawer ===== */
  .replyWrap{
    position: fixed; inset: 0; display:none; z-index: 50;
  }
  .replyWrap.active{ display:block; }
  .replyBack{
    position:absolute; inset:0; background: rgba(2,8,23,.55); backdrop-filter: blur(2px);
  }
  .replyPanel{
    position:absolute; top:0; right:0; height:100%; width: min(560px, 100%);
    background: var(--modal-bg);
    border-left: 1px solid var(--modal-br);
    box-shadow: -10px 0 24px rgba(0,0,0,.35);
    padding: 16px;
    display:flex; flex-direction:column; gap:12px;
  }
  .rpHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .rpTitle{ font-size:18px; font-weight:900; }
  .rpClose{
    appearance:none; background:transparent; border:1px solid #3a4b7d; color:#e6eefb; border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:800;
  }
  .rpForm{ display:grid; gap:10px; }
  .rpRow{ display:grid; gap:6px; }
  .rpFoot{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:4px; }

  .noteList{ display:grid; gap:10px; max-height: 260px; overflow:auto; padding-right:4px; }
  .noteCard{
    background:#0b1730; border:1px solid #22335f; border-radius:10px; padding:10px; color:#dbeafe;
  }
  .noteMeta{ font-size:12px; opacity:.8; display:flex; gap:8px; flex-wrap:wrap; }
  .noteBody{ white-space:pre-wrap; margin-top:6px; }
  .noteDel{
    appearance:none; border:1px solid #7a2a2a; color:#fff; background:#c43d3d; border-radius:8px; padding:4px 8px;
    font-size:12px; font-weight:800; cursor:pointer;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <span class="dot" aria-hidden="true"></span>
      <div class="brand">Azoul <small style="opacity:.75;font-weight:700;margin-left:.35rem">Manager</small></div>
    </header>

    <!-- Login -->
    <section class="panel" id="loginPanel">
      <div class="panel-inner">
        <h1>Manager Login</h1>
        <div class="row">
          <div>
            <label for="mEmail">Manager Email</label>
            <input id="mEmail" class="input" type="email" placeholder="manager@example.com" />
          </div>
          <div>
            <label for="mCode">Manager Access Code</label>
            <input id="mCode" class="input" type="password" placeholder="Enter access code" />
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; align-items:center; justify-content:flex-end">
          <button id="loginBtn" class="btn">View Reports</button>
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section class="panel" id="dashPanel" style="margin-top:14px; display:none">
      <div class="panel-inner">
        <div class="topbar">
          <div>
            <h1 style="margin:0">Employee Reports</h1>
            <div class="muted" id="countText">0 results</div>
          </div>
          <div class="right">
            <span class="pill" id="mWho">‚Äî</span>
          </div>
        </div>

        <div class="filters">
          <select id="teamFilter">
            <option value="all">All Teams</option>
          </select>
          <select id="issueFilter">
            <option value="all">All Issues</option>
            <option value="harassment">Harassment</option>
            <option value="safety">Safety</option>
            <option value="burnout">Burnout</option>
            <option value="overtime">Overtime</option>
            <option value="low-pay">Low Pay</option>
            <option value="management">Management</option>
            <option value="career">Career Growth</option>
            <option value="benefits">Benefits</option>
            <option value="culture">Culture</option>
          </select>
          <button class="btn" id="resetBtn" style="background:transparent;color:#e6eefb;border:1px solid rgba(255,255,255,.2)">Reset</button>
        </div>

        <!-- ===== Folder + Content Area ===== -->
        <div class="folderArea">
          <!-- Tabs (vertical, like your image) -->
          <div class="folderTabs" role="tablist" aria-label="Folders">
            <button class="folderTab active" data-tab="greenTab" role="tab" aria-selected="true">
              <div class="tabRow">
                <span class="tabLabel">FILE 1 ¬∑ Green Messages</span>
                <span class="tabHint">üü¢</span>
                <span class="tabCount" id="cntGreen">0</span>
              </div>
            </button>

            <button class="folderTab" data-tab="yellowTab" role="tab" aria-selected="false">
              <div class="tabRow">
                <span class="tabLabel">FILE 2 ¬∑ Yellow Messages</span>
                <span class="tabHint">üü°</span>
                <span class="tabCount" id="cntYellow">0</span>
              </div>
            </button>

            <button class="folderTab" data-tab="redTab" role="tab" aria-selected="false">
              <div class="tabRow">
                <span class="tabLabel">FILE 3 ¬∑ Red Messages</span>
                <span class="tabHint">üî¥</span>
                <span class="tabCount" id="cntRed">0</span>
              </div>
            </button>

            <button class="folderTab" data-tab="chartTab" role="tab" aria-selected="false">
              <div class="tabRow">
                <span class="tabLabel">FILE 4 ¬∑ Well‚ÄëBeing</span>
                <span class="tabHint">üìä</span>
                <span class="tabCount" id="cntAll">0</span>
              </div>
            </button>
          </div>

          <!-- Folder Content -->
          <div class="folderBody">
            <div id="greenTab" class="tabPane active" role="tabpanel" aria-labelledby="tab-green">
              <div id="listGreen" class="list"></div>
            </div>

            <div id="yellowTab" class="tabPane" role="tabpanel" aria-labelledby="tab-yellow">
              <div id="listYellow" class="list"></div>
            </div>

            <div id="redTab" class="tabPane" role="tabpanel" aria-labelledby="tab-red">
              <div id="listRed" class="list"></div>
            </div>

            <div id="chartTab" class="tabPane" role="tabpanel" aria-labelledby="tab-chart">
              <div style="display:grid;place-items:center;padding:12px">
                <canvas id="wellChart" width="360" height="360" aria-label="Well‚ÄëBeing Chart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <!-- ===== End Folder Area ===== -->

      </div>
    </section>
  </div>

  <!-- ===== Reply Drawer (modal) ===== -->
  <div id="replyWrap" class="replyWrap" aria-hidden="true">
    <div class="replyBack" id="rpBack"></div>
    <aside class="replyPanel" role="dialog" aria-modal="true" aria-labelledby="rpTitle">
      <div class="rpHead">
        <div id="rpTitle" class="rpTitle">Reply to Employee</div>
        <button id="rpClose" class="rpClose">Close ‚úï</button>
      </div>

      <form id="replyForm" class="rpForm">
        <div class="rpRow">
          <label for="rpTo">To</label>
          <input id="rpTo" class="input" type="email" readonly />
        </div>

        <div class="rpRow">
          <label for="rpSubject">Subject</label>
          <input id="rpSubject" class="input" type="text" placeholder="Regarding your report‚Ä¶" />
        </div>

        <div class="rpRow">
          <label for="rpVisibility">Visibility</label>
          <select id="rpVisibility">
            <option value="employee">Visible to Employee</option>
            <option value="internal">Internal (Managers only)</option>
          </select>
        </div>

        <div class="rpRow">
          <label for="rpBody">Message</label>
          <textarea id="rpBody" placeholder="Type your reply‚Ä¶"></textarea>
        </div>

        <div class="rpFoot">
          <button type="button" id="rpCancel" class="btn-ghost">Cancel</button>
          <button type="submit" class="btn">Save Note</button>
        </div>
      </form>

      <div style="margin-top:4px">
        <div class="rpTitle" style="font-size:16px">Notes History</div>
        <div id="noteList" class="noteList"></div>
      </div>
    </aside>
  </div>

<script>
  // ====== CONFIG ======
  const MANAGER_CODE = "azoul-admin-2025"; // change for production

  // ====== COLOR MAP for badges ======
  const issueColors = {
    "harassment": "b-red",
    "safety": "b-red",
    "burnout": "b-orange",
    "overtime": "b-amber",
    "low-pay": "b-indigo",
    "management": "b-purple",
    "career": "b-teal",
    "benefits": "b-blue",
    "culture": "b-slate",
  };

  // ====== DOM ======
  const loginPanel = document.getElementById('loginPanel');
  const dashPanel  = document.getElementById('dashPanel');
  const mEmail     = document.getElementById('mEmail');
  const mCode      = document.getElementById('mCode');
  const mWho       = document.getElementById('mWho');
  const loginBtn   = document.getElementById('loginBtn');

  const teamFilter = document.getElementById('teamFilter');
  const issueFilter= document.getElementById('issueFilter');
  const resetBtn   = document.getElementById('resetBtn');
  const countText  = document.getElementById('countText');

  const listGreen  = document.getElementById('listGreen');
  const listYellow = document.getElementById('listYellow');
  const listRed    = document.getElementById('listRed');

  const paneGreen  = document.getElementById('greenTab');
  const paneYellow = document.getElementById('yellowTab');
  const paneRed    = document.getElementById('redTab');
  const paneChart  = document.getElementById('chartTab');

  const cntGreen   = document.getElementById('cntGreen');
  const cntYellow  = document.getElementById('cntYellow');
  const cntRed     = document.getElementById('cntRed');
  const cntAll     = document.getElementById('cntAll');

  // Reply drawer elements
  const replyWrap  = document.getElementById('replyWrap');
  const rpBack     = document.getElementById('rpBack');
  const rpClose    = document.getElementById('rpClose');
  const rpCancel   = document.getElementById('rpCancel');
  const replyForm  = document.getElementById('replyForm');
  const rpTo       = document.getElementById('rpTo');
  const rpSubject  = document.getElementById('rpSubject');
  const rpBody     = document.getElementById('rpBody');
  const rpVisibility = document.getElementById('rpVisibility');
  const noteList   = document.getElementById('noteList');

  let chartRef = null; // Chart.js instance
  let currentReplyRid = null; // which report we're replying to

  // ====== Helpers: storage ======
  function getReports(){
    try { return JSON.parse(localStorage.getItem('azoul_reports') || '[]'); }
    catch { return []; }
  }
  function setReports(arr){
    localStorage.setItem('azoul_reports', JSON.stringify(arr));
  }

  function getReplies(){
    try { return JSON.parse(localStorage.getItem('azoul_replies') || '[]'); }
    catch { return []; }
  }
  function setReplies(arr){
    localStorage.setItem('azoul_replies', JSON.stringify(arr));
  }

  // ====== (Optional) DEMO SEED ======
  // Uncomment this block once to see sample data
  /*
  if (!getReports()?.length) {
    setReports([
      { id:"r-1", user:{email:"sara@azoul.com", team:"Support"}, selections:["culture","benefits"], other:"Loves the team rituals", savedAt: Date.now()-86400000 },
      { id:"r-2", user:{email:"ken@azoul.com", team:"Ops"}, selections:["overtime","burnout"], other:"12h shifts often", savedAt: Date.now()-3600*1000*5 },
      { id:"r-3", user:{email:"lee@azoul.com", team:"Warehouse"}, selections:["safety"], other:"Forklift near-miss", savedAt: Date.now()-3600*1000*2 },
      { id:"r-4", user:{email:"mina@azoul.com", team:"Engineering"}, selections:["career","management"], other:"Wants mentorship", savedAt: Date.now()-600000 },
      { id:"r-5", user:{email:"jo@azoul.com", team:"Ops"}, selections:["harassment"], other:"Reported incident", savedAt: Date.now()-300000 },
    ]);
  }
  */

  // ====== Helpers: Pretty / Badges ======
  const renderBadge = (key) => {
    const cls = issueColors[key] || 'b-slate';
    const pretty = ({
      "low-pay":"Low Pay",
      "harassment":"Harassment",
      "burnout":"Burnout",
      "overtime":"Overtime",
      "safety":"Safety",
      "management":"Management",
      "career":"Career Growth",
      "benefits":"Benefits",
      "culture":"Culture"
    })[key] || key;
    return `<span class="badge ${cls}">${pretty}</span>`;
  };

  const uniqueTeams = (arr) => [...new Set(arr.map(r => (r?.user?.team || 'N/A')))].sort((a,b)=>a.localeCompare(b));

  // Filters
  const passesFilters = (r, tVal, iVal) => {
    const teamOK = (tVal === 'all' || (r?.user?.team || 'N/A') === tVal);
    const issueOK = (iVal === 'all' || (r?.selections || []).includes(iVal));
    return teamOK && issueOK;
  };

  // ====== Stable ID for reports ======
  function stableId(r){
    if (r?.id != null) return String(r.id);
    if (r?._id != null) return String(r._id);
    try{
      const s = JSON.stringify({
        e: r?.user?.email || '',
        t: r?.user?.team || '',
        a: r?.savedAt || '',
        o: r?.other || '',
        s: (r?.selections || []).join('|')
      });
      let h=0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))>>>0; }
      return "h-" + h.toString(16);
    }catch{
      // very rare fallback
      return "h-" + Math.random().toString(36).slice(2,9);
    }
  }

  function findReportByRid(rid){
    const all = getReports();
    for (let i=0;i<all.length;i++){
      if (stableId(all[i]) === rid) return {r: all[i], index: i};
    }
    return {r:null,index:-1};
  }

  // ====== Severity ======
  function getSeverity(report){
    const issues = report?.selections || [];
    if (issues.some(x => ["harassment", "safety"].includes(x))) return "red";
    if (issues.some(x => ["burnout", "overtime", "low-pay"].includes(x))) return "yellow";
    return "green";
  }

  // ====== Delete handler ======
  async function handleRowDelete(ev, rid, posHint) {
    const hard = ev.shiftKey; // Shift+Click => hard delete
    if (hard && !confirm("Hard delete this report? This cannot be undone.")) return;

    const all = getReports();
    let idx = all.findIndex(r => stableId(r) === rid);

    // fallback to position if we didn't find by stable id
    if (idx < 0 && typeof posHint === 'number') idx = posHint;

    if (idx >= 0) {
      all.splice(idx, 1);
      setReports(all);

      // If hard delete, also purge replies for this report
      if (hard) {
        const replies = getReplies().filter(n => n.reportRid !== rid);
        setReplies(replies);
      }
    }

    fetchAndRender(); // refresh
  }

  // ====== Reply / Notes ======
  function openReplyDrawer(rid){
    currentReplyRid = rid;

    // Fill "To" and a default subject
    const { r } = findReportByRid(rid);
    rpTo.value = r?.user?.email || '';
    rpSubject.value = `Regarding your report`;
    rpVisibility.value = 'employee';
    rpBody.value = '';

    // Load note history
    renderNoteHistory(rid);

    replyWrap.classList.add('active');
    replyWrap.setAttribute('aria-hidden','false');
  }

  function closeReplyDrawer(){
    replyWrap.classList.remove('active');
    replyWrap.setAttribute('aria-hidden','true');
    currentReplyRid = null;
  }

  function renderNoteHistory(rid){
    const notes = getReplies()
      .filter(n => n.reportRid === rid)
      .sort((a,b) => b.createdAt - a.createdAt);

    if (!notes.length){
      noteList.innerHTML = `<div class="noteCard">No notes yet.</div>`;
      return;
    }

    noteList.innerHTML = notes.map(n => {
      const when = new Date(n.createdAt).toLocaleString();
      const vis = n.visibility === 'internal' ? 'Internal' : 'Visible';
      return `
        <div class="noteCard" data-note-id="${n.id}">
          <div class="noteMeta">
            <strong>${vis}</strong>
            <span>¬∑</span>
            <span>${when}</span>
            ${n.author ? `<span>¬∑ by ${n.author}</span>` : ''}
            <span style="margin-left:auto"></span>
            <button class="noteDel" type="button">Delete</button>
          </div>
          <div class="noteBody">${escapeHtml(n.body)}</div>
          ${n.subject ? `<div class="noteMeta" style="margin-top:6px">Subject: <em>${escapeHtml(n.subject)}</em></div>` : ''}
        </div>
      `;
    }).join('');

    // Wire delete for each note
    noteList.querySelectorAll('.noteCard .noteDel').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        const card = ev.target.closest('.noteCard');
        const id = card?.getAttribute('data-note-id');
        if (!id) return;
        if (!confirm('Delete this note?')) return;
        const next = getReplies().filter(n => n.id !== id);
        setReplies(next);
        renderNoteHistory(rid);
        refreshNoteCountPills(rid);
      });
    });
  }

  function refreshNoteCountPills(rid){
    const count = getReplies().filter(n => n.reportRid === rid).length;
    // Update any pill on the page with this rid
    document.querySelectorAll(`.noteCount[data-rid="${CSS.escape(rid)}"]`).forEach(el => el.textContent = String(count));
  }

  replyForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!currentReplyRid) return;

    const to = rpTo.value.trim();
    const subject = rpSubject.value.trim();
    const body = rpBody.value.trim();
    const visibility = rpVisibility.value;

    if (!body){ alert('Please write a message.'); return; }

    const notes = getReplies();
    notes.push({
      id: 'note-' + Date.now() + '-' + Math.random().toString(36).slice(2,7),
      reportRid: currentReplyRid,
      to,
      subject,
      body,
      visibility,   // 'employee' | 'internal'
      createdAt: Date.now(),
      author: mWho.textContent || 'Manager'
    });
    setReplies(notes);

    // Clear body, keep drawer open, refresh history & pill
    rpBody.value = '';
    renderNoteHistory(currentReplyRid);
    refreshNoteCountPills(currentReplyRid);
  });

  [rpBack, rpClose, rpCancel].forEach(el => el.addEventListener('click', closeReplyDrawer));

  // Small util for safe rendering
  function escapeHtml(s=''){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ====== Rendering ======

  /**
   * Build markup for one report card.
   */
  function buildCard(r, pos){
    const rid = stableId(r);
    const email = r?.user?.email || 'Unknown';
    const team = r?.user?.team || 'N/A';
    const when = r?.savedAt ? new Date(r.savedAt).toLocaleString() : '‚Äî';
    const badges = (r?.selections || []).map(renderBadge).join(' ');
    const other = r?.other || '‚Äî';
    const sev = getSeverity(r);
    const sevClass = sev === 'red' ? 'sev-red' : (sev === 'yellow' ? 'sev-yellow' : 'sev-green');

    const noteCount = getReplies().filter(n => n.reportRid === rid).length;

    return `
      <div class="card ${sevClass}" data-rid="${String(rid)}" data-pos="${pos}">
        <button class="del-x" type="button" aria-label="Delete report" title="Click: delete. Hold Shift: hard delete.">üóëÔ∏è</button>

        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div><strong>${email}</strong> ¬∑ <span class="muted">${team}</span></div>
          <div class="muted">${when}</div>
        </div>
        <div class="badges">${badges || '<span class="badge b-slate">No issue selected</span>'}</div>
        <div><span class="muted">Other:</span> ${escapeHtml(other)}</div>

        <div class="cardActions">
          <button class="btn-mini replyBtn" type="button">Reply</button>
          <button class="btn-mini ghost historyBtn" type="button">
            Notes (<span class="noteCount" data-rid="${String(rid)}">${noteCount}</span>)
          </button>
        </div>
      </div>
    `;
  }

  /**
   * Render all 3 lists from a view of { r, pos } items that already pass filters.
   */
  function renderLists(view){
    const bySev = { green:[], yellow:[], red:[] };

    view.forEach(({r, pos}) => {
      const sev = getSeverity(r);
      const card = buildCard(r, pos);
      bySev[sev].push(card);
    });

    listGreen.innerHTML  = bySev.green.join('')  || `<div class="empty">No green messages</div>`;
    listYellow.innerHTML = bySev.yellow.join('') || `<div class="empty">No yellow messages</div>`;
    listRed.innerHTML    = bySev.red.join('')    || `<div class="empty">No red messages</div>`;

    // Wire delete + reply + history buttons in all lists
    [listGreen, listYellow, listRed].forEach(listEl => {
      // delete
      listEl.querySelectorAll('.card .del-x').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          const card = ev.target.closest('.card');
          if (!card) return;
          const rid = card.getAttribute('data-rid');
          const pos = Number(card.getAttribute('data-pos')) || -1;
          handleRowDelete(ev, rid, pos);
        });
      });
      // reply
      listEl.querySelectorAll('.card .replyBtn').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          const card = ev.target.closest('.card');
          const rid = card?.getAttribute('data-rid');
          if (!rid) return;
          openReplyDrawer(rid);
        });
      });
      // history = also opens drawer
      listEl.querySelectorAll('.card .historyBtn').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          const card = ev.target.closest('.card');
          const rid = card?.getAttribute('data-rid');
          if (!rid) return;
          openReplyDrawer(rid);
        });
      });
    });

    // Counts
    cntGreen.textContent  = bySev.green.length;
    cntYellow.textContent = bySev.yellow.length;
    cntRed.textContent    = bySev.red.length;
    cntAll.textContent    = view.length;
    countText.textContent = `${view.length} result${view.length===1?'':'s'}`;
  }

  // Chart
  function renderWellChart(stats){
    const ctx = document.getElementById('wellChart');
    const data = {
      labels: ["Red (Severe)", "Yellow (Moderate)", "Green (Positive)"],
      datasets: [{
        data: [stats.red, stats.yellow, stats.green],
        backgroundColor: ["#dc2626","#eab308","#22c55e"],
        borderColor: ["#fff","#fff","#fff"],
        borderWidth: 2,
        hoverOffset: 6
      }]
    };
    const options = {
      plugins:{
        legend:{ display:true, labels:{ color:"#e6eefb" } },
        tooltip:{ enabled:true }
      }
    };

    if (chartRef) {
      chartRef.data = data;
      chartRef.update();
    } else {
      chartRef = new Chart(ctx, { type:"doughnut", data, options });
    }
  }

  // Aggregate for chart (from full filtered view)
  function summarize(view){
    let red=0,yellow=0,green=0;
    view.forEach(({r}) => {
      const sev = getSeverity(r);
      if (sev === "red") red++;
      else if (sev === "yellow") yellow++;
      else green++;
    });
    return { red, yellow, green };
  }

  // ====== Fetch + Render pipeline ======
  function fetchAndRender(){
    const all = getReports();

    // Build filtered view while keeping original index (pos) so delete works as fallback
    const t = teamFilter.value;
    const i = issueFilter.value;

    const view = all.map((r, pos) => ({ r, pos }))
                    .filter(({r}) => passesFilters(r, t, i));

    // Populate teams on first load (after login)
    if (!teamFilter.dataset.populated) {
      const teams = uniqueTeams(all);
      teamFilter.innerHTML = `<option value="all">All Teams</option>` + teams.map(t => `<option value="${t}">${t}</option>`).join('');
      teamFilter.dataset.populated = "1";
    }

    renderLists(view);
    // If chart tab is currently visible, update chart immediately
    if (paneChart.classList.contains('active')) {
      renderWellChart(summarize(view));
    }
  }

  // ====== Tabs behavior ======
  document.querySelectorAll('.folderTab').forEach(btn => {
    btn.addEventListener('click', () => {
      const tabId = btn.getAttribute('data-tab');

      // activate tab button
      document.querySelectorAll('.folderTab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // show pane
      [paneGreen, paneYellow, paneRed, paneChart].forEach(p => p.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');

      // If the chart tab is opened, (re)render the chart with current filtered data
      if (tabId === 'chartTab') {
        const all = getReports();
        const t = teamFilter.value;
        const i = issueFilter.value;
        const view = all.map((r, pos) => ({ r, pos })).filter(({r}) => passesFilters(r, t, i));
        renderWellChart(summarize(view));
      }
    });
  });

  // ====== Login flow ======
  loginBtn.addEventListener('click', () => {
    const email = mEmail.value.trim();
    const code  = mCode.value.trim();
    if(!email || !code){ alert('Fill all fields'); return; }
    if(code !== MANAGER_CODE){ alert('Wrong manager code'); return; }

    // show dashboard
    loginPanel.style.display = 'none';
    dashPanel.style.display  = 'block';
    mWho.textContent = email;

    // mark filters not populated yet
    delete teamFilter.dataset.populated;

    // initial render
    fetchAndRender();

    // wiring
    teamFilter.addEventListener('change', fetchAndRender);
    issueFilter.addEventListener('change', fetchAndRender);
    resetBtn.addEventListener('click', () => {
      teamFilter.value = 'all';
      issueFilter.value = 'all';
      fetchAndRender();
    });
  });

  // ====== Guard: if no file found (prevent "code at top" leftovers) ======
  window.addEventListener('DOMContentLoaded', ()=>{
    ['#debug','#dump','.raw','.codesat','pre.dump','pre.raw'].forEach(sel =>
      document.querySelectorAll(sel).forEach(n => n.remove())
    );
  });
</script>
</body>
</html>
